<script src="https://www.google.com/jsapi"></script>
<script src="chartkick.js"></script>

<%
  if ENV.has_key? "NASA"
    nasa_api_key = ENV.fetch("NASA")

    url_near_earth = "https://api.nasa.gov/neo/rest/v1/feed?start_date=2015-09-07&end_date=2015-09-08&api_key=#{nasa_api_key}"
    
    require "http"
    raw_response = HTTP.get(url_near_earth)
    data = Hash.new

    require "json"
    parsed_response = JSON.parse(raw_response)
    number_of_objects = parsed_response["element_count"]
    near_earth_objects =  parsed_response["near_earth_objects"]
   
    near_earth_objects.each { |daily|
  %>
      <b><%= daily.first %> Asteriods</b><br/>
      <% 
        daily[1].each { |object|
          name = object["name"]
      %>
        <% if object["is_potentially_hazardous_asteroid"] %>
          <%= name + "❗" %>
        <% else %>
          <%= name %>
        <% end 
          diameter = (object["estimated_diameter"]["meters"]["estimated_diameter_min"] + object["estimated_diameter"]["meters"]["estimated_diameter_max"]) / 2
          miss_distance = object["close_approach_data"].first["miss_distance"]["miles"]
          data[miss_distance] = diameter
        %>
        <%= diameter %> meters diameter
        <%= miss_distance %> miles from Earth
        <hr/>
      <%
        }
        plot_data = data.sort
      } %>
      <hr/>
<%= line_chart data %>
<% else %>
no key
<% end %>
